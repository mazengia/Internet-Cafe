<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Users â€¢ Internet Cafe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/images/icon.v1.png" />
    <style>
      body { padding:20px; background:#f7f9fc; }
      .card { border-radius:12px; }
      .table-responsive { margin-top:12px; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Users</h3>
        <div>
          <a href="/dashboard" class="btn btn-outline-secondary">Back to Dashboard</a>
        </div>
      </div>

      <div class="card p-3 mb-3">
        <div class="row g-2">
          <div class="col-md-3"><input id="new-username" class="form-control" placeholder="Username"></div>
          <div class="col-md-3"><input id="new-name" class="form-control" placeholder="Name"></div>
          <div class="col-md-3"><input id="new-password" class="form-control" placeholder="Password"></div>
          <div class="col-md-3"><input id="new-roles" class="form-control" placeholder="Roles (comma separated)"></div>
        </div>
        <div class="mt-3 text-end">
          <button id="create-user" class="btn btn-primary">Create user</button>
        </div>
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="users-table">
            <thead class="table-light">
              <tr><th>ID</th><th>Username</th><th>Name</th><th>Roles</th><th>Action</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit user</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="edit-id">
            <div class="mb-3"><label class="form-label">Name</label><input id="edit-name" class="form-control"></div>
            <div class="mb-3"><label class="form-label">Password (leave empty to keep)</label><input id="edit-password" class="form-control" type="password"></div>
            <div class="mb-3"><label class="form-label">Roles (comma separated)</label><input id="edit-roles" class="form-control"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="save-edit" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function authHeaders() { const token = localStorage.getItem('jwt_token'); const h = {'Content-Type':'application/json'}; if(token) h['Authorization'] = 'Bearer ' + token; return h; }
      function authOptions(extra) { const token = localStorage.getItem('jwt_token'); const headers = {'Content-Type':'application/json'}; let opts = { headers }; if(token) headers['Authorization'] = 'Bearer ' + token; else opts.credentials = 'same-origin'; if(extra && extra.method) opts.method = extra.method; if(extra && extra.body) opts.body = extra.body; return opts; }

      async function loadUsers(){
        const res = await fetch('/api/v1/admin/users', authOptions());
        const tbody = document.querySelector('#users-table tbody');
        if(!res.ok){ tbody.innerHTML = '<tr><td colspan="5">Unable to load users (are you admin?)</td></tr>'; return; }
        const list = await res.json(); tbody.innerHTML = '';
        list.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.id}</td><td>${u.username}</td><td>${u.name||''}</td><td>${(u.authorities||[]).map(a=>a.name).join(',')}</td><td><button class="btn btn-sm btn-outline-primary edit" data-id="${u.id}" data-username="${u.username}">Edit</button> <button class="btn btn-sm btn-outline-danger del" data-id="${u.id}">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      }

      document.getElementById('create-user').addEventListener('click', async () => {
        const username = document.getElementById('new-username').value;
        const name = document.getElementById('new-name').value;
        const password = document.getElementById('new-password').value;
        const roles = (document.getElementById('new-roles').value||'').split(',').map(s=>s.trim()).filter(s=>s);
        const res = await fetch('/api/v1/admin/users', {method:'POST', headers: authHeaders(), body: JSON.stringify({username,name,password,roles})});
        if(!res.ok){ alert('Create failed: '+await res.text()); return; }
        document.getElementById('new-username').value=''; document.getElementById('new-name').value=''; document.getElementById('new-password').value=''; document.getElementById('new-roles').value='';
        await loadUsers();
      });

      document.querySelector('#users-table').addEventListener('click', (e)=>{
        if(e.target.matches('.del')){
          const id = e.target.getAttribute('data-id'); if(!confirm('Delete user '+id+'?')) return; fetch('/api/v1/admin/users/'+id,{method:'DELETE',headers:authHeaders()}).then(r=>{ if(!r.ok) alert('Delete failed'); else loadUsers(); });
        }
        if(e.target.matches('.edit')){
          const id = e.target.getAttribute('data-id');
          fetch('/api/v1/admin/users',{method:'GET',headers:authHeaders()}).then(r=>r.json()).then(list=>{ const u = list.find(x=>x.id==id); if(!u) { alert('Not found'); return; } document.getElementById('edit-id').value=u.id; document.getElementById('edit-name').value=u.name||''; document.getElementById('edit-password').value=''; document.getElementById('edit-roles').value=(u.authorities||[]).map(a=>a.name).join(','); var m = new bootstrap.Modal(document.getElementById('editModal')); m.show(); });
        }
      });

      document.getElementById('save-edit').addEventListener('click', async ()=>{
        const id = document.getElementById('edit-id').value; const name = document.getElementById('edit-name').value; const password = document.getElementById('edit-password').value; const roles = (document.getElementById('edit-roles').value||'').split(',').map(s=>s.trim()).filter(s=>s);
        const res = await fetch('/api/v1/admin/users/'+id, {method:'PUT', headers: authHeaders(), body: JSON.stringify({name,password,roles})});
        if(!res.ok){ alert('Update failed: '+await res.text()); return; }
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        await loadUsers();
      });

      loadUsers();
    </script>
  </body>
</html>
