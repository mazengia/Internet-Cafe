<div class="container-fluid py-3">
  <div class="row">
    <main class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Users</h4>
      </div>

      <div class="card-soft p-3 mb-3">
        <form id="create-user-form" class="row g-2">
          <div class="col-12 col-md-3">
            <label for="u-username" class="form-label visually-hidden">Username</label>
            <input id="u-username" class="form-control" placeholder="Username" aria-label="New username">
          </div>
          <div class="col-12 col-md-3">
            <label for="u-name" class="form-label visually-hidden">Name</label>
            <input id="u-name" class="form-control" placeholder="Name" aria-label="New name">
          </div>
          <div class="col-12 col-md-3">
            <label for="u-password" class="form-label visually-hidden">Password</label>
            <input id="u-password" class="form-control" placeholder="Password" type="password" aria-label="New password">
          </div>
          <div class="col-12 col-md-2">
            <label for="u-roles" class="form-label visually-hidden">Roles</label>
            <input id="u-roles" class="form-control" placeholder="Roles (comma separated)" aria-label="New roles">
          </div>
          <div class="col-12 col-md-1 text-end">
            <button type="submit" class="btn btn-primary">Create</button>
          </div>
        </form>
      </div>

      <div class="card-soft p-3">
        <div class="table-responsive">
          <table class="table table-sm align-middle" id="users-table">
            <thead><tr><th>ID</th><th>Username</th><th>Name</th><th>Roles</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Edit modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit user</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-id">
        <div class="mb-3"><label for="edit-name" class="form-label">Name</label><input id="edit-name" class="form-control" aria-label="Edit name"></div>
        <div class="mb-3"><label for="edit-password" class="form-label">Password (leave empty to keep)</label><input id="edit-password" class="form-control" type="password" aria-label="Edit password"></div>
        <div class="mb-3"><label for="edit-roles" class="form-label">Roles (comma separated)</label><input id="edit-roles" class="form-control" aria-label="Edit roles"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="save-edit" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
// users fragment: defines initUsers()
function initUsers(){
  const state = { users: [] };
  const tbody = document.querySelector('#users-table tbody');

  function authOptions(extra){ const token = localStorage.getItem('jwt_token'); const headers={'Content-Type':'application/json'}; const opts={headers}; if(token) headers['Authorization']='Bearer '+token; else opts.credentials='same-origin'; if(extra?.method) opts.method=extra.method; if(extra?.body) opts.body=extra.body; return opts; }

  function render(){
    tbody.innerHTML = '';
    state.users.forEach(u=>{
      const tr = document.createElement('tr');
      const roles = (u.authorities||[]).map(a=>a.name).join(',');
      tr.innerHTML = `<td>${u.id}</td><td>${u.username}</td><td>${u.name||''}</td><td>${roles}</td><td><button class="btn btn-sm btn-outline-primary edit-user" data-id="${u.id}">Edit</button> <button class="btn btn-sm btn-outline-danger delete-user" data-id="${u.id}">Delete</button></td>`;
      tbody.appendChild(tr);
    });
  }

  async function load(){
    try{
      const res = await fetch('/api/v1/admin/users', authOptions());
      if(!res.ok){ tbody.innerHTML = '<tr><td colspan="5">Unable to load users</td></tr>'; return; }
      state.users = await res.json(); render();
    }catch(e){ console.error(e); tbody.innerHTML = '<tr><td colspan="5">Error loading users</td></tr>'; }
  }

  // create
  document.getElementById('create-user-form').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const username = document.getElementById('u-username').value.trim();
    const name = document.getElementById('u-name').value.trim();
    const password = document.getElementById('u-password').value;
    const roles = (document.getElementById('u-roles').value||'').split(',').map(s=>s.trim()).filter(s=>s);
    try{
      const res = await fetch('/api/v1/admin/users', { method:'POST', headers: authOptions().headers, body: JSON.stringify({username,name,password,roles}) });
      if(!res.ok){ alert('Create failed: '+await res.text()); return; }
      document.getElementById('u-username').value=''; document.getElementById('u-name').value=''; document.getElementById('u-password').value=''; document.getElementById('u-roles').value='';
      await load();
    }catch(e){ console.error(e); alert('Create error'); }
  });

  // delegated edit/delete
  document.querySelector('#users-table').addEventListener('click', async (e)=>{
    if(e.target.matches('.delete-user')){
      const id = e.target.dataset.id; if(!confirm('Delete user '+id+'?')) return; try{ const res=await fetch('/api/v1/admin/users/'+id, { method:'DELETE', headers: authOptions().headers }); if(!res.ok){ alert('Delete failed'); return; } await load(); }catch(err){ console.error(err); alert('Delete error'); }
    }
    if(e.target.matches('.edit-user')){
      const id = e.target.dataset.id; const u = state.users.find(x=>String(x.id)===String(id)); if(!u){ alert('User not found'); return; }
      document.getElementById('edit-id').value = u.id; document.getElementById('edit-name').value = u.name||''; document.getElementById('edit-password').value=''; document.getElementById('edit-roles').value=(u.authorities||[]).map(a=>a.name).join(',');
      new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }
  });

  // save edit
  document.getElementById('save-edit').addEventListener('click', async ()=>{
    const id = document.getElementById('edit-id').value; const name = document.getElementById('edit-name').value; const password = document.getElementById('edit-password').value; const roles = (document.getElementById('edit-roles').value||'').split(',').map(s=>s.trim()).filter(s=>s);
    try{ const res = await fetch('/api/v1/admin/users/'+id, { method:'PUT', headers: authOptions().headers, body: JSON.stringify({name,password,roles}) }); if(!res.ok){ alert('Update failed: '+await res.text()); return; } bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide(); await load(); }catch(e){ console.error(e); alert('Update error'); }
  });


  // init
  load();
}

// if fragment executed inline, call initUsers
try{ if(typeof initUsers === 'function') initUsers(); }catch(e){}
</script>
