<div class="container-fluid py-3">
    <div class="row g-3">
        <main class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Computers</h4>
            </div>

            <!-- Stats -->
            <div class="row g-3 mb-3">
                <div class="col-12 col-md-4">
                    <div class="glass p-3 stat">
                        <i class="bi bi-pc-display"></i>
                        <div>
                            <div class="metric" id="stat-total">—</div>
                            <small class="text-secondary">Total Computers</small>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="glass p-3 stat">
                        <i class="bi bi-play-circle"></i>
                        <div>
                            <div class="metric" id="stat-running">—</div>
                            <small class="text-secondary">Running Sessions</small>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="glass p-3 stat">
                        <i class="bi bi-cash-coin"></i>
                        <div>
                            <div class="metric" id="stat-revenue">—</div>
                            <small class="text-secondary">Live Revenue</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Computers Grid -->
            <div id="computers-grid" class="row g-3"></div>

            <!-- Running Sessions Table -->
            <div class="glass p-3 mt-4" id="sessions">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Running Sessions</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm align-middle" id="sessions-table">
                        <thead>
                        <tr>
                            <th>Computer</th>
                            <th>MAC</th>
                            <th>Elapsed</th>
                            <th>Price/hr</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<style>
    /* Glass cards */
    .glass {
        border-radius: 12px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .glass:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
    }

    /* Stats cards */
    .stat {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .stat i {
        color: #7c3aed;
        font-size: 1.6rem;
        flex-shrink: 0;
    }

    .metric {
        font-weight: 700;
        font-size: 1.4rem;
    }

    @media (max-width: 768px) {
        .metric {
            font-size: 1.1rem;
        }
    }

    /* Pills / status badges */
    .pill {
        display: inline-block;
        padding: 0.3rem 0.6rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .pill.success {
        background-color: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .pill.muted {
        background-color: rgba(148, 163, 184, 0.2);
        color: #94a3b8;
    }

    .pill.danger {
        background-color: rgba(220, 38, 38, 0.2);
        color: #dc2626;
    }

    /* Tables */
    #sessions-table {
        background: transparent;
    }

    #sessions-table thead th {
        position: sticky;
        top: 0;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(6px);
        z-index: 2;
        /*color: #fff;*/
    }

    #sessions-table tbody tr td {
        vertical-align: middle;
        /*color: #eee;*/
    }

    .btn-sm {
        min-width: 75px;
        font-weight: 600;
    }

    /* Computers grid */
    #computers-grid > .col-12 {
        margin-bottom: 12px;
    }

    .computer .btn {
        font-weight: 600;
        transition: transform 0.15s;
    }

    .computer .btn:hover {
        transform: translateY(-1px);
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .stat i {
            font-size: 1.3rem;
        }
        .metric {
            font-size: 1rem;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
<script>
    function initDashboard() {
        const state = {computers: {}, sessions: {}};
        const gridEl = document.getElementById('computers-grid');
        const sessionsTbody = document.querySelector('#sessions-table tbody');
        const statTotal = document.getElementById('stat-total');
        const statRunning = document.getElementById('stat-running');
        const statRevenue = document.getElementById('stat-revenue');

        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        function cardTemplate(c, elapsed, total) {
            const name = escapeHtml(c.name || ('Computer ' + (c.id || '')));
            const mac = escapeHtml(c.macAddress || '');
            const price = c.branchPrice || '-';

            let statusBadge = `<span class="pill muted">AVAILABLE</span>`;
            if (c.status === 'IN_USE') statusBadge = `<span class="pill success">IN USE</span>`;
            if (c.status === 'LOCKED') statusBadge = `<span class="pill danger">LOCKED</span>`;
            if (c.status === 'SHUTDOWN') statusBadge = `<span class="pill danger">SHUTDOWN</span>`;
            if (c.status === 'SHUTDOWN_SUDDENLY') statusBadge = `<span class="pill danger">SHUTDOWN_SUDDENLY</span>`;




            const startClass = (c.status !== 'AVAILABLE') ? ' d-none' : '';
            const stopClass = (c.status === 'IN_USE') ? '' : ' d-none';
            const lockClass = (c.status === 'IN_USE' || c.status === 'AVAILABLE') ? '' : ' d-none';
            const shoutdownClass = (c.status === 'IN_USE' || c.status === 'AVAILABLE'|| c.status === 'LOCKED') ? '' : ' d-none';
            return `
<div class="col-12 col-md-6 col-lg-4">
  <div class="glass p-3 computer h-100">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div>
        <div class="fw-semibold">${name}</div>
        <div class="small text-muted">${mac}</div>
      </div>
      ${statusBadge}
    </div>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div><small class="text-muted">Elapsed</small><div class="metric">${elapsed}</div></div>
      <div><small class="text-muted">Price/hr</small><div>${price}</div></div>
      <div><small class="text-muted">Total</small><div>${total}</div></div>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-sm btn-success start-btn${startClass}" data-id="${c.id}"><i class="bi bi-play-fill"></i> Start</button>
      <button class="btn btn-sm btn-warning stop-btn${stopClass}" data-id="${c.id}"><i class="bi bi-stop-fill"></i> Stop</button>
      <button class="btn btn-sm btn-danger lock-btn${lockClass}" data-id="${c.id}"><i class="bi bi-lock-fill"></i> Lock</button>
      <button class="btn btn-sm btn-dark shutdown-btn${shoutdownClass}" data-id="${c.id}"><i class="bi bi-power"></i> Shutdown</button>
    </div>
  </div>
</div>`;
        }

        function renderGrid() {
            gridEl.innerHTML = '';
            Object.values(state.computers).forEach(c => {
                const elapsed = state.sessions[c.id]?.elapsed || '-';
                const total = state.sessions[c.id]?.totalCost || '-';
                gridEl.insertAdjacentHTML('beforeend', cardTemplate(c, elapsed, total));
            });
            renderSessionsTable();
            updateStats();
        }

        function renderSessionsTable() {
            sessionsTbody.innerHTML = '';
            Object.values(state.computers).forEach(c => {
                if (c.status === 'IN_USE') {
                    const elapsed = state.sessions[c.id]?.elapsed || '-';
                    const total = state.sessions[c.id]?.totalCost || '-';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
          <td>${escapeHtml(c.name || '')}</td>
          <td>${escapeHtml(c.macAddress || '')}</td>
          <td>${elapsed}</td>
          <td>${c.branchPrice || '-'}</td>
          <td>${total}</td>
          <td>
            <button class="btn btn-sm btn-warning stop-btn" data-id="${c.id}">Stop</button>
          </td>`;
                    sessionsTbody.appendChild(tr);
                }
            });
        }

        function updateStats() {
            const comps = Object.values(state.computers || {});
            const total = comps.length;
            const running = comps.filter(c => c.status === 'IN_USE').length;
            let revenue = 0;
            Object.values(state.sessions).forEach(s => {
                const v = parseFloat(s.totalCost);
                if (!isNaN(v)) revenue += v;
            });
            statTotal.innerText = total;
            statRunning.innerText = running;
            statRevenue.innerText = revenue ? revenue.toFixed(2) : '-';
        }

        async function fetchComputers() {
            try {
                const res = await fetch('/computers?page=0&size=1000', authOptions());
                if (!res.ok) throw new Error('Failed to load computers');
                const data = await res.json();
                const comps = Array.isArray(data) ? data : (data.content || []);
                comps.forEach(c => state.computers[c.id] = {
                    ...c,
                    branchPrice: c.branch?.pricePerHour || c.branchPrice || '-',
                    status: c.status || 'AVAILABLE'
                });
                renderGrid();
            } catch (e) {
                console.error('fetchComputers', e);
            }
        }

        let stompClient;

        function startStomp() {
            try {
                const host = window.location.hostname;
                const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
                const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                const wsUrl = `${wsProtocol}://${host}:${port}/ws`;
                stompClient = new StompJs.Client({
                    brokerURL: wsUrl,
                    onConnect: () => {
                        stompClient.subscribe('/topic/sessions', msg => {
                            try {
                                const p = JSON.parse(msg.body);
                                if (p.id) {
                                    state.sessions[p.id] = {elapsed: p.elapsed, totalCost: p.totalCost};
                                    if (state.computers[p.id]) state.computers[p.id].status = 'IN_USE';
                                }
                                renderGrid();
                            } catch (ex) {
                                console.error('stomp msg', ex);
                            }
                        });
                    },
                    onStompError: err => console.error('STOMP error', err),
                    debug: () => {
                    }
                });
                stompClient.activate();
            } catch (e) {
                console.warn('stomp init failed', e);
            }
        }

        function authOptions(extra) {
            const token = localStorage.getItem('jwt_token');
            const headers = {'Content-Type': 'application/json'};
            if (token) headers['Authorization'] = 'Bearer ' + token;
            const opts = {headers};
            if (extra?.method) opts.method = extra.method;
            if (extra?.body) opts.body = extra.body;
            return opts;
        }

        document.addEventListener('click', async ev => {
            const t = ev.target.closest('button');
            if (!t) return;

            // START
            if (t.matches('.start-btn')) {
                const id = t.dataset.id;
                const price = prompt('Price per hour (optional)');
                const body = price ? JSON.stringify({pricePerHour: parseFloat(price)}) : JSON.stringify({});
                try {
                    const r = await fetch(`/sessions/${id}/start`, authOptions({method: 'POST', body}));
                    if (!r.ok) return alert('Start failed');
                    state.computers[id].status = 'IN_USE';
                    renderGrid();
                } catch (e) {
                    alert('Start error');
                }
            }

            // STOP
            if (t.matches('.stop-btn')) {
                const id = t.dataset.id;
                try {
                    const r = await fetch(`/sessions/${id}/stop-running`, authOptions({method: 'POST'}));
                    if (!r.ok) return alert('Stop failed');
                    state.computers[id].status = 'AVAILABLE';
                    renderGrid();
                } catch (e) {
                    alert('Stop error');
                }
            }

            // LOCK
            if (t.matches('.lock-btn')) {
                const id = t.dataset.id;
                if (!confirm('Lock this computer?')) return;
                try {
                    const r = await fetch(`/computers/${id}/lock`, authOptions({method: 'POST'}));
                    if (!r.ok) return alert('Lock failed');
                    state.computers[id].status = 'LOCKED';
                    renderGrid();
                } catch (e) {
                    alert('Lock error');
                }
            }

            // SHUTDOWN
            if (t.matches('.shutdown-btn')) {
                const id = t.dataset.id;
                if (!confirm('Are you sure you want to shutdown this computer?')) return;
                try {
                    const r = await fetch(`/computers/${id}/shoutdown`, authOptions({method: 'POST'}));
                    if (!r.ok) return alert('Shutdown failed');
                    state.computers[id].status = 'LOCKED'; // Optionally mark as LOCKED
                    renderGrid();
                } catch (e) {
                    alert('Shutdown error');
                }
            }
        });

        async function updateUserArea() {
            const ua = document.getElementById('user-area');
            if (!ua) return;
            const token = localStorage.getItem('jwt_token');
            try {
                const res = await fetch('/api/auth/me', token ? {headers: {'Authorization': 'Bearer ' + token}} : {credentials: 'same-origin'});
                if (!res.ok) {
                    ua.innerHTML = `<a href="/login" class="btn btn-sm btn-outline-light">Login</a>`;
                    return;
                }
                const j = await res.json();
                ua.innerHTML = `<strong>${j.name || ''}</strong> <button id="logout" class="btn btn-sm btn-outline-light ms-2">Logout</button>`;
                document.getElementById('logout').addEventListener('click', async () => {
                    try {
                        await fetch('/api/auth/logout', {method: 'POST', credentials: 'same-origin'});
                    } catch (e) {
                    }
                    localStorage.removeItem('jwt_token');
                    window.location.href = '/login';
                });
            } catch (e) {
                ua.innerHTML = `<a href="/login" class="btn btn-sm btn-outline-light">Login</a>`;
            }
        }

        updateUserArea();
        fetchComputers();
        startStomp();

        // Optional: highlight computer by ID
        function focusComputerById(id) {
            if (!id) return;
            setTimeout(() => {
                const cardBtn = document.querySelector(`[data-id='${id}']`);
                if (cardBtn) {
                    const card = cardBtn.closest('.computer');
                    if (card) {
                        card.style.boxShadow = '0 0 0 3px rgba(124,58,237,0.35)';
                        card.scrollIntoView({behavior: 'smooth', block: 'center'});
                        setTimeout(() => {
                            card.style.boxShadow = '';
                        }, 4000);
                    }
                }
            }, 500);
        }

        try {
            const focusId = localStorage.getItem('focus_computer');
            if (focusId) {
                focusComputerById(focusId);
                localStorage.removeItem('focus_computer');
            }
        } catch (e) {
        }
    }

    try {
        if (typeof initDashboard === 'function') initDashboard();
    } catch (e) {
    }
</script>
